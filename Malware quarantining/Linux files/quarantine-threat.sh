#!/bin/bash

LOCAL=$(dirname "$0")
cd "$LOCAL" || exit 1
cd ../ || exit 1

PWD=$(pwd)
LOG_FILE="${PWD}/../logs/active-responses.log"
QUARANTINE_DIR="${PWD}/../quarantine"

# Ensure quarantine directory exists
mkdir -p "$QUARANTINE_DIR"

# Read input JSON
read -r INPUT_JSON

# Extract filename and command from JSON
FILENAME=$(echo "$INPUT_JSON" | jq -r .parameters.alert.data.yara_scanned_file)
COMMAND=$(echo "$INPUT_JSON" | jq -r .command)

# Validate extracted values
if [ -z "$FILENAME" ] || [ -z "$COMMAND" ]; then
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: Missing filename or command in input JSON" >> "$LOG_FILE"
  exit 1
fi

#------------------------ Analyze command -------------------------#
if [ "$COMMAND" = "add" ]; then
  # Send control message to execd
  printf '{"version":1,"origin":{"name":"quarantine-threat","module":"active-response"},"command":"check_keys","parameters":{"keys":[]}}\n'

  read -r RESPONSE
  COMMAND2=$(echo "$RESPONSE" | jq -r .command)
  if [ "$COMMAND2" != "continue" ]; then
    echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Quarantine threat active response aborted" >> "$LOG_FILE"
    exit 0
  fi
fi

# Generate timestamp and move file to quarantine
TIMESTAMP=$(date '+%Y%m%d%H%M%S')
BASENAME=$(basename "$FILENAME")
QUARANTINED_FILE="$QUARANTINE_DIR/${BASENAME}_$TIMESTAMP"

mv "$FILENAME" "$QUARANTINED_FILE" 2>/dev/null
if [ -e "$QUARANTINED_FILE" ]; then
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Successfully quarantined threat to $QUARANTINED_FILE" >> "$LOG_FILE"
else
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Error quarantining threat" >> "$LOG_FILE"
fi

exit 0