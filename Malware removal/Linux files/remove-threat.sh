#!/bin/bash

LOCAL=$(dirname "$0")
cd "$LOCAL" || exit 1
cd ../ || exit 1

PWD=$(pwd)
LOG_FILE="${PWD}/../logs/active-responses.log"

# Read input JSON
read -r INPUT_JSON

# Extract filename and command from JSON
FILENAME=$(echo "$INPUT_JSON" | jq -r .parameters.alert.data.yara_scanned_file)
COMMAND=$(echo "$INPUT_JSON" | jq -r .command)

# Validate extracted values
if [ -z "$FILENAME" ] || [ -z "$COMMAND" ]; then
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: Missing filename or command in input JSON" >> "$LOG_FILE"
  exit 1
fi

#------------------------ Analyze command -------------------------#
if [ "$COMMAND" = "add" ]; then
  # Send control message to execd
  printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys","parameters":{"keys":[]}}\n'

  read -r RESPONSE
  COMMAND2=$(echo "$RESPONSE" | jq -r .command)
  if [ "$COMMAND2" != "continue" ]; then
    echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Remove threat active response aborted" >> "$LOG_FILE"
    exit 0
  fi
fi

# Attempt to remove file and log success or failure
rm -f "$FILENAME" 2>/dev/null
if [ -e "$FILENAME" ]; then
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Error removing threat" >> "$LOG_FILE"
else
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Successfully removed threat" >> "$LOG_FILE"
fi

exit 0